export default defineEventHandler(async (event) => {
  const body = await readBody(event);
  const question = body?.question;

  if (!question || typeof question !== 'string') {
    throw createError({
      statusCode: 400,
      statusMessage: 'Question is required'
    });
  }

  // Rule-based chatbot with predefined answers
  const questionLower = question.toLowerCase().trim();
  
  // Answers based on keywords
  let answer = '';

  if (questionLower.includes('что делает') || questionLower.includes('что делает ваш проект') || questionLower.includes('что такое linkagro')) {
    answer = 'Наш проект LINKAGRO помогает банкам решать проблему высоких рисков агрокредитования, предоставляя объективную оценку кредитоспособности фермеров на основе спутниковых данных. Продукт автоматизирует анализ состояния полей, расчёт индексов вегетации (NDVI, NDWI, EVI, SAVI, NDMI) и мониторинг использования кредитных средств. Система использует AI для прогнозирования урожайности и автоматического расчёта кредитного скоринга, что позволяет банкам принимать обоснованные решения на основе реальных данных, а не субъективных оценок.';
  } 
  else if (questionLower.includes('для кого') || questionLower.includes('целевая аудитория') || questionLower.includes('кто использует')) {
    answer = 'Этот продукт создан для банков и финансовых организаций, занимающихся агрокредитованием, включая организации, сталкивающиеся с проблемой высоких рисков невозврата кредитов и отсутствия объективных данных о заёмщиках. Например, банк, испытывающий трудности с оценкой кредитоспособности фермеров, может значительно снизить риски и увеличить портфель качественных агрокредитов с помощью нашего приложения. Также платформа может быть полезна страховым компаниям и агрохолдингам для мониторинга состояния полей.';
  }
  else if (questionLower.includes('ai') || questionLower.includes('искусственный интеллект') || questionLower.includes('машинное обучение')) {
    answer = 'Наш проект использует AI для анализа спутниковых данных и генерации рекомендаций. Конкретно: 1) Автоматический расчёт индексов вегетации (NDVI, NDWI, EVI, SAVI, NDMI) из спутниковых снимков для оценки состояния посевов. 2) Machine Learning модели для прогнозирования урожайности на основе исторических данных и текущих индексов. 3) AI-алгоритмы кредитного скоринга, которые анализируют множество факторов (состояние полей, история хозяйства, региональные данные) для объективной оценки кредитоспособности. 4) Обнаружение аномалий и рисков (засуха, болезни, вредители) через анализ изменений индексов во времени.';
  }
  else if (questionLower.includes('технологии') || questionLower.includes('стек') || questionLower.includes('технологический стек')) {
    answer = 'Мы используем современный технологический стек: Frontend - Nuxt 3 (Vue 3), TypeScript, Tailwind CSS, Leaflet/Mapbox для карт. Backend - Python (FastAPI/Flask) для обработки данных и ML-моделей. AI/ML - Machine Learning модели для прогнозирования, интеграция со спутниковыми API (Sentinel Hub, Landsat). Система работает с большими объёмами геопространственных данных и обеспечивает реальное время мониторинга полей.';
  }
  else if (questionLower.includes('как работает') || questionLower.includes('как это работает') || questionLower.includes('принцип работы')) {
    answer = 'LINKAGRO работает следующим образом: 1) Система получает спутниковые снимки полей заёмщика через API (Sentinel Hub, Landsat). 2) Автоматически рассчитываются индексы вегетации (NDVI, NDWI, EVI, SAVI, NDMI) для оценки состояния посевов. 3) AI-модели анализируют исторические данные и текущие показатели для прогнозирования урожайности. 4) На основе всех данных система рассчитывает кредитный скоринг и предоставляет рекомендации банковскому специалисту. 5) Банк получает объективную оценку и может принимать обоснованные решения о выдаче кредита.';
  }
  else if (questionLower.includes('статус') || questionLower.includes('этап') || questionLower.includes('стадия')) {
    answer = 'Проект находится на стадии MVP (Minimum Viable Product). Реализованы основные функции: спутниковый мониторинг, расчёт индексов, базовый AI-скоринг и визуализация данных. Система проходит тестирование с пилотными банками. Следующие шаги: интеграция с банковскими системами через API, расширение AI-моделей, добавление мобильного приложения для фермеров, масштабирование на новые регионы.';
  }
  else if (questionLower.includes('цена') || questionLower.includes('стоимость') || questionLower.includes('тарифы')) {
    answer = 'Для получения информации о тарифах и стоимости использования платформы LINKAGRO, пожалуйста, свяжитесь с нами по email: info@linkagro.com. Мы предлагаем индивидуальные решения в зависимости от объёма использования и потребностей вашей организации.';
  }
  else if (questionLower.includes('контакты') || questionLower.includes('связаться') || questionLower.includes('связь')) {
    answer = 'С нами можно связаться по email: info@linkagro.com. Мы готовы ответить на все ваши вопросы и обсудить возможности сотрудничества.';
  }
  else {
    // Default answer for unrecognized questions
    answer = 'Спасибо за ваш вопрос! LINKAGRO - это платформа для объективной оценки кредитоспособности фермеров на основе спутниковых данных и AI. Если у вас есть конкретные вопросы о функциональности, технологиях или возможностях платформы, задайте их более детально, и я постараюсь помочь. Вы также можете связаться с нами напрямую: info@linkagro.com';
  }

  return {
    answer: answer
  };
});


